const { SlashCommandBuilder, EmbedBuilder, ActionRowBuilder, StringSelectMenuBuilder, ComponentType } = require('discord.js');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('help')
        .setDescription('WyÅ›wietla listÄ™ dostÄ™pnych komend'),
    
    async execute(interaction) {
        // Kategoryzacja komend
        const categories = {
            'administracyjne': {
                emoji: 'ðŸ›¡ï¸',
                color: '#f04a4a',
                description: 'ZarzÄ…dzanie serwerem i uÅ¼ytkownikami',
                commands: ['ban', 'kick', 'mute', 'unmute', 'unban', 'clear']
            },
            'narzÄ™dzia': {
                emoji: 'ðŸ”§',
                color: '#4a9ff0',
                description: 'Przydatne funkcje i ustawienia',
                commands: ['ping', 'help', 'customcommands', 'premium-handler']
            },
            'wspÃ³Å‚praca': {
                emoji: 'ðŸ¤',
                color: '#4af04a',
                description: 'Reklama i wspÃ³Å‚praca miÄ™dzyserwerowa',
                commands: ['wspolpraca', 'autowspolpraca']
            },
            '4fun': {
                emoji: 'ðŸŽ®',
                color: '#f0c64a',
                description: 'Gry i zabawy dla spoÅ‚ecznoÅ›ci',
                commands: ['8ball', 'losowaliczba', 'mem', 'coinflip', 'kamiennozycepapier', 'wybierz']
            },
            'poziomy': {
                emoji: 'â­',
                color: '#a64aff',
                description: 'System poziomÃ³w i rankingu',
                commands: ['rank', 'ranking', 'poziomy-ustawienia', 'admin-poziom']
            },
            'weryfikacja': {
                emoji: 'âœ…',
                color: '#00cc88',
                description: 'System weryfikacji uÅ¼ytkownikÃ³w',
                commands: ['weryfikacja-send', 'weryfikacja-settings']
            },
            'tickety': {
                emoji: 'ðŸŽ«',
                color: '#ff8c42',
                description: 'System ticketÃ³w i wsparcia',
                commands: ['ticketpanel', 'ticket-settings', 'close-ticket']
            },
            'przywitania': {
                emoji: 'ðŸ‘‹',
                color: '#ee82ee',
                description: 'System powitalny dla nowych czÅ‚onkÃ³w',
                commands: ['przywitanie']
            }
        };
        
        // PoczÄ…tkowy embed gÅ‚Ã³wnego menu
        const mainEmbed = new EmbedBuilder()
            .setTitle('```ðŸ’œ``` Visual Ã— Pomoc')
            .setDescription('> *Witaj w pomocy bota Visual!* \n> *Wybierz kategoriÄ™ z menu poniÅ¼ej*\n\n> **ðŸ“ Wybierz kategoriÄ™**')
            .setColor('#FF69B4')
            .setThumbnail(interaction.client.user.displayAvatarURL())
            .addFields(
                { name: 'ðŸ“š Komendy', value: '```yml\nâ€¢ ' + interaction.client.commands.size + ' komend slash\n```', inline: true },
                { name: 'ðŸŒŸ Funkcje', value: '```yml\nâ€¢ Moderacja\nâ€¢ System poziomÃ³w\nâ€¢ System ticketÃ³w\nâ€¢ System weryfikacji\nâ€¢ System powitaÅ„\nâ€¢ WÅ‚asne komendy\nâ€¢ Gry i zabawy\n```', inline: true },
                { name: '\u200B', value: '> **Visual - TwÃ³j Asystent!**', inline: false }
            )
            .setImage('https://i.imgur.com/ao9EMiz.png') 
            .setTimestamp()
            .setFooter({ text: 'Visual Bot', iconURL: interaction.client.user.displayAvatarURL() });
        
        const row = new ActionRowBuilder()
            .addComponents(
                new StringSelectMenuBuilder()
                    .setCustomId('help_category')
                    .setPlaceholder('ðŸ“ Wybierz kategoriÄ™ komend')
                    .addOptions(
                        Object.entries(categories).map(([key, value]) => ({
                            label: key.charAt(0).toUpperCase() + key.slice(1),
                            description: value.description,
                            value: key,
                            emoji: value.emoji
                        }))
                    )
            );
            
        const response = await interaction.reply({
            embeds: [mainEmbed],
            components: [row],
            ephemeral: true
        });
        
        const collector = response.createMessageComponentCollector({
            time: 5 * 60 * 1000, 
        });
        
        collector.on('collect', async i => {
            if (i.user.id !== interaction.user.id) {
                return i.reply({
                    content: '> **To menu nie jest dla Ciebie!**',
                    ephemeral: true
                });
            }
            
            if (i.isStringSelectMenu()) {
                const selectedCategory = i.values[0];
                const categoryInfo = categories[selectedCategory];
                
                const categoryEmbed = new EmbedBuilder()
                    .setTitle(`\`\`\`${categoryInfo.emoji}\`\`\`  Visual Ã— ${selectedCategory.charAt(0).toUpperCase() + selectedCategory.slice(1)}`)
                    .setDescription(`> *${categoryInfo.description}*\n\n> **Lista dostÄ™pnych komend w tej kategorii:**`)
                    .setColor(categoryInfo.color || '#FF69B4')
                    .setThumbnail(interaction.client.user.displayAvatarURL())
                    .setTimestamp()
                    .setFooter({ text: 'Visual Bot | Wybierz innÄ… kategoriÄ™ lub wrÃ³Ä‡ do menu gÅ‚Ã³wnego', iconURL: interaction.client.user.displayAvatarURL() });
                
                // Dla kategorii pokazujemy komendy slash
                const { commands } = interaction.client;
                const categoryCommands = commands.filter(cmd => categoryInfo.commands.includes(cmd.data.name));
                
                if (categoryCommands.size > 0) {
                    categoryCommands.forEach(cmd => {
                        categoryEmbed.addFields({
                            name: `${categoryInfo.emoji} \`/${cmd.data.name}\``,
                            value: `\`\`\`yml\nâ€¢ ${cmd.data.description}\n\`\`\``,
                            inline: false
                        });
                    });
                } else {
                    categoryEmbed.addFields({
                        name: 'âŒ Brak komend',
                        value: `\`\`\`yml\nâ€¢ W tej kategorii nie ma jeszcze komend\n\`\`\``,
                        inline: false
                    });
                }
                
                await i.update({ embeds: [categoryEmbed], components: [row] });
            }
        });
        
        collector.on('end', async (collected, reason) => {
            if (reason === 'time') {
                const timeoutEmbed = new EmbedBuilder()
                    .setTitle('```â°``` Visual Ã— Sesja zakoÅ„czona ')
                    .setDescription('> *Czas na przeglÄ…danie centrum pomocy minÄ…Å‚!*\n\n> **ðŸ’« UÅ¼yj komendy `/help` ponownie, aby otworzyÄ‡ centrum pomocy.**')
                    .setColor('#FF69B4')
                    .setThumbnail(interaction.client.user.displayAvatarURL())
                    .setImage('https://i.imgur.com/yTEloMY.png') 
                    .setTimestamp()
                    .setFooter({ text: 'Visual Bot | Czas sesji: 5 minut', iconURL: interaction.client.user.displayAvatarURL() });
                
                await interaction.editReply({
                    embeds: [timeoutEmbed],
                    components: []
                }).catch(() => {});
            }
        });
    }
};